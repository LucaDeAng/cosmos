# Backend System

Complete backend implementation for user management, authentication, initiatives, and file uploads.

## Features

✅ **User Management**
- User registration with email verification
- Secure login with JWT tokens
- Password reset functionality
- Account lockout after failed attempts
- Role-based access control (user, admin, super_admin)

✅ **Company Management**
- Multi-tenant support
- Subscription plans
- User limits per company
- Company-level isolation

✅ **Initiative Management**
- Create, read, update, delete initiatives
- Priority levels (low, medium, high, critical)
- Status tracking (draft, pending, approved, in_progress, completed, archived)
- Custom variables per initiative
- Full audit trail

✅ **File Upload Security**
- File type validation
- Size limits (50MB default)
- Virus scanning integration ready
- File integrity verification (SHA-256)
- Secure file storage
- Access control

✅ **Security Features**
- JWT authentication
- Password hashing (bcrypt)
- Rate limiting
- Row-level security (RLS)
- Audit logging
- SQL injection protection
- XSS protection (helmet)

## Environment Variables

Create a `.env` file in the backend directory:

```env
# Server
PORT=3000
NODE_ENV=development
APP_URL=http://localhost:3000
FRONTEND_URL=http://localhost:3001

# Supabase
SUPABASE_URL=https://xtfrgfqgjfrnrfqmsbgk.supabase.co
SUPABASE_SERVICE_KEY=your-service-key-here
KG_SUPABASE_URL=https://xtfrgfqgjfrnrfqmsbgk.supabase.co
KG_SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here

# Database
DATABASE_URL=postgresql://postgres:password@host:5432/database

# JWT
JWT_SECRET=your-secret-key-change-in-production

# File Upload
UPLOAD_DIR=./uploads

# Email (optional - configure your email service)
EMAIL_FROM=noreply@yourapp.com
```

## Installation

```bash
cd backend
npm install
```

## Database Setup

1. Run the migration to create tables:
```bash
# Option 1: Using Supabase Dashboard
# Copy the SQL from migrations/001_initial_schema.sql
# Paste into Supabase SQL Editor and run

# Option 2: Using direct database connection
npm run migrate
```

2. The migration creates:
   - `users` table
   - `companies` table
   - `initiatives` table
   - `uploaded_files` table
   - `audit_logs` table
   - `user_sessions` table
   - All necessary indexes and triggers
  - A recent migration also adds a dedicated table for LLM-generated assessment snapshots:
    - `company_assessment_snapshots` (see migrations/006_company_assessment_snapshots.sql). This table stores validated JSON snapshots generated by the assessment agent and has a unique index on `assessment_id` so writes use upsert semantics.
   - Row-level security policies

## Running the Server

```bash
# Development mode with auto-reload
npm run dev

# Production mode
npm run build
npm start
```

## API Endpoints

### Authentication
```
POST   /api/auth/register        - Register new user
POST   /api/auth/login           - Login user
GET    /api/auth/verify-email    - Verify email address
POST   /api/auth/forgot-password - Request password reset
POST   /api/auth/reset-password  - Reset password
```

### Users
```
GET    /api/users/profile              - Get current user profile
PUT    /api/users/profile              - Update user profile
GET    /api/users/company/:companyId   - Get company users (admin)
DELETE /api/users/:userId/deactivate   - Deactivate user (admin)
```

### Initiatives
```
POST   /api/initiatives           - Create initiative
GET    /api/initiatives           - List initiatives (with filters)
GET    /api/initiatives/:id       - Get initiative details
PUT    /api/initiatives/:id       - Update initiative
DELETE /api/initiatives/:id       - Delete initiative
GET    /api/initiatives/stats     - Get statistics (admin)
```

### Files
```
POST   /api/files/upload                - Upload file
GET    /api/files                       - List files (with filters)
GET    /api/files/:id                   - Get file metadata
DELETE /api/files/:id                   - Delete file
GET    /api/files/:id/verify-integrity  - Verify file integrity
```

## Authentication

All protected endpoints require a JWT token in the Authorization header:

```
Authorization: Bearer <your-jwt-token>
```

Get the token from the `/api/auth/login` response.

## Example Requests

### Register User
```bash
curl -X POST http://localhost:3000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!",
    "fullName": "John Doe",
    "companyName": "ACME Corp"
  }'
```

### Login
```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!"
  }'
```

### Create Initiative
```bash
curl -X POST http://localhost:3000/api/initiatives \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Q1 Marketing Campaign",
    "description": "Launch new product line",
    "priority": "high",
    "variables": [
      {"name": "budget", "min": 10000, "max": 50000},
      {"name": "duration", "min": 30, "max": 90}
    ]
  }'
```

### Upload File
```bash
curl -X POST http://localhost:3000/api/files/upload \
  -H "Authorization: Bearer <token>" \
  -F "file=@document.pdf" \
  -F "initiativeId=<initiative-uuid>"
```

## Security Best Practices

1. **Change default secrets** - Update `JWT_SECRET` in production
2. **Use HTTPS** - Always use SSL/TLS in production
3. **Configure email service** - Set up proper email verification
4. **Implement virus scanning** - Integrate ClamAV or cloud service
5. **Regular backups** - Set up automated database backups
6. **Monitor logs** - Review audit logs regularly
7. **Update dependencies** - Keep packages up to date
8. **Rate limiting** - Adjust rate limits based on your needs

## Project Structure

```
backend/
├── src/
│   ├── auth/
│   │   └── auth.service.ts
│   ├── config/
│   │   └── supabase.ts
│   ├── middleware/
│   │   └── auth.middleware.ts
│   ├── routes/
│   │   ├── auth.routes.ts
│   │   ├── user.routes.ts
│   │   ├── initiative.routes.ts
│   │   └── file.routes.ts
│   ├── services/
│   │   ├── user.service.ts
│   │   ├── initiative.service.ts
│   │   └── file-upload.service.ts
│   ├── utils/
│   │   └── email.ts
│   └── index.ts
├── migrations/
│   └── 001_initial_schema.sql
├── scripts/
│   └── run-migration.js
├── package.json
└── tsconfig.json
```

## Testing

Use tools like Postman or curl to test endpoints. A Postman collection is recommended for easier testing.

## Troubleshooting

### Database Connection Issues
- Verify `SUPABASE_URL` and `SUPABASE_SERVICE_KEY` are correct
- Check network connectivity to Supabase
- Ensure your IP is allowed in Supabase settings

### Authentication Errors
- Check JWT token is being sent correctly
- Verify token hasn't expired
- Ensure user account is active and verified

### File Upload Failures
- Check file size is under 50MB
- Verify file type is in allowed list
- Ensure upload directory exists and has write permissions

## License

ISC
